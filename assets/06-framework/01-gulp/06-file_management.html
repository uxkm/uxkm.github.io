

	<header>
		<h1></h1><!-- 속도 개선과 파일 및 오류 관리 -->
		<time class="last_update" datetime="2021-00-00">2021-00-00</time>
	</header>

	<blockquote class="uk_note mt_xxl" role="note">
		<h2 class="sound_only">요약 설명</h2>
		<p>
			퍼블리셔에게 가장 중요하며 기본이 되는 역활은 html, css를 이용하여 정적인 홈페이지를 완벽하게 구축하는것입니다.<br>
			물론 javascript를 이용하여 동적 ui까지 구현하는 것도 어느정도 퍼블리셔의 역활이지만 이는 프로젝트 필요가 있기도 없기도 합니다.
		</p>
		<p class="mt_ms">
			UXKM의 Gulp 1.1 ~ 1.5 단계 까지 우리는 Gulp 시스템을 이용하여 scss와 html을 관리하는 방법은 배웠습니다.
			그리고 앞에까지 진행했던 과정에 더해 조금 더 편리하고 효율적인 기능을 추가할 예정입니다.<br>
			순서에 따라 가자면 지금 우리는 js파일에 대한 병합 및 압축과 이미지, 라이브러리 관리 등으로 넘어가야 하지만
			앞서 언급한 것처럼 퍼블리셔로서 가장 중요한 역활과 요소인 html, css를 조금 더 효율적으로 관리하기 위한 내용으로 진행하겠습니다.
		</p>
	</blockquote>


	<!-- 1.5.1. 개선 및 관리 방향 -->
	<section class="indent mt_xxl">
		<h2 class="ml_mn">1.5.1. 개선 및 관리 방향</h2>

		<!-- 속도 개선 -->
		<article class="indent mt_l">
			<h3 class="ml_mn">속도 개선</h3>
			<ul class="dot_lst indent mt_ms">
				<li>효율적인 scss 컴파일</li>
				<li>변경, 추가된 html 파일만 build</li>
			</ul>
		</article>

		<!-- 파일 관리 -->
		<article class="indent mt_l">
			<h3 class="ml_mn">파일 관리</h3>
			<ul class="dot_lst indent mt_ms">
				<li>불필요한 파일 정리를 위해 gulp 실행 시 dist 폴더 초기화</li>
				<li>gulp 실행 중 src = dist 실시간 파일 동기화</li>
			</ul>
		</article>

		<!-- 오류 관리 -->
		<article class="indent mt_l">
			<h3 class="ml_mn">오류 관리</h3>
			<ul class="dot_lst indent mt_ms">
				<li>오류 발생 시 gulp가 죽지 않도록 예외 처리 및 error handling</li>
			</ul>
		</article>
	</section>


	<!-- 1.5.2. 개선 및 관리 진행 -->
	<section class="indent mt_xxl">
		<h2 class="ml_mn">1.5.2. 개선 및 관리 진행</h2>

		<ol class="ol_lst">
			<!-- 패키지 설치 -->
			<li class="tit_h3 mt_xl">
				<h3>패키지 설치</h3>
				<p class="mt_ms">
					명령프롬프트에서 아래의 명령어를 입력합니다.
				</p>
				<div class="terminal_code_box mt_ms">
					<textarea>
						//full code
						npm install gulp-file-include -D  // html include
						npm install gulp-htmlmin -D        // html 압축

						//shorthand
						npm install -D gulp-file-include gulp-htmlmin
					</textarea>
				</div>
			</li>

			<!-- gulpfile.js 파일 수정 -->
			<li class="tit_h3 mt_xl">
				<h3>gulpfile.js 파일 수정</h3>
				<p class="mt_ms">
					<mark>gulpfile.js</mark>를 아래 처럼 수정합니다.<br>
				</p>
				<div class="uk_gist_code_box mt_ms" data-filename="gulpfile.js" data-tit="gulpfile.js">
					<textarea>
						// plug-in 연결
						//
						// 생략...
						//
						const del            = require('del');                  // --add-- 파일 삭제
						const dependents     = require('gulp-dependents');      // --add-- 종속(@import)되는 css, scss, less 컴파일
						const cached         = require('gulp-cached');          // --add-- cache를 이용하여 변경된 파일만 빌드 진행
						const path           = require('path');                 // --add-- 파일의 경로 생성
						const plumber        = require('gulp-plumber');         // --add-- 에러 발생 시 gulp강제 종료 방지 및 에러 핸들링

						// --no_change-- autoprefixer 옵션: 브라우저 버전 지정

						// --add-- 기타 설정
						const onErrorHandler = (error) => console.log(error);  //plumber option (에러 발생 시 에러 로그 출력)

						// --no_change-- 소스 파일 경로

						// --edit-- scss 컴파일

						// --edit-- html 빌드

						// --no_change-- app.js 파일을 참조하여 express 서버 구동

						// --edit-- 변경, 추가되는 파일을 감지하여 자동 빌드

						// --no_change-- 빌드된 내용을 브라우저에 반영

						// --add-- 빌드 시 불필요한 파일 삭제

						// --edit-- 실행
					</textarea>
				</div>
				<div class="uk_gist_code_box full_code_layer" data-filename="gulpfile.js" data-tit="gulpfile.js">
					<textarea>
						// plug-in 연결
						const gulp           = require("gulp");                 // gulp 연결
						const Fiber          = require('fibers');               // dart sass 이용시 gulp-sass와 세트 플러그인
						const dartSass       = require('dart-sass');            // dart-sass 연결(기본)
						const scss           = require('gulp-sass');            // gulp-sass 연결(기본)
						const sourcemaps     = require('gulp-sourcemaps');      // css.map 파일 생성용
						const minificss      = require('gulp-minify-css');      // css 압축
						const autoprefixer   = require('autoprefixer');         // 고려할 브라우저 버전 설정
						const postCss        = require('gulp-postcss');         // 설정한 브라우저에 버전에 맞춰 css 컴파일
						const rename         = require('gulp-rename');          // 파일 이름 변경
						const nodemon        = require('gulp-nodemon');         // 파일 변경이 감지될 때 자동으로 재시작
						const browserSync    = require('browser-sync');         // 변경된 내용을 브라우저에 적용
						const fileinclude    = require('gulp-file-include');    // html include를 위한 플러그인 연결
						const htmlmin        = require('gulp-htmlmin');         // html 압축

						const del            = require('del');                  // 파일 삭제
						const dependents     = require('gulp-dependents');      // 종속(@import)되는 css, scss, less 컴파일
						const cached         = require('gulp-cached');          // cache를 이용하여 변경된 파일만 빌드 진행
						const path           = require('path');                 // 파일의 경로 생성
						const plumber        = require('gulp-plumber');         // 에러 발생 시 gulp강제 종료 방지 및 에러 핸들링


						// autoprefixer 옵션: 브라우저 버전 지정
						const apfBrwsowsers = [
							'ie > 0', 'chrome > 0', 'firefox > 0'  // 브라우저의 모든 버전 적용
							//'last 2 versions'                    // 최신 브라우저 기준 하위 2개의 버전까지 적용
						];


						// 기타 설정
						const onErrorHandler = (error) => console.log(error);  //plumber option (에러 발생 시 에러 로그 출력)


						// 소스 파일 경로
						const src = './src';
						const dist = './dist';
						const assets = '/assets';
						// 작업폴더 경로 ('src'에서 작업한 것을)
						const PATH = {
							HTML: src + '/html',
							ASSETS: {
								CSS: src + assets + '/css',
								FONTS: src + assets + '/fonts',
								IMAGES: src + assets + '/images',
								JS: src + assets + '/js',
								LIB: src + assets + '/lib',
							}
						}
						// 산출물 경로 ('dist'에 생성한다.)
						const DEST_PATH = {
							HTML: dist,
							ASSETS: {
								CSS: dist + assets +'/css',
								FONTS: dist + assets +'/fonts',
								IMAGES: dist + assets +'/images',
								JS: dist + assets +'/js',
								LIB: dist + assets + '/lib',
							}
						};


						// scss 컴파일
						gulp.task('scss:compile', () => {
							return new Promise(resolve => {
								const options = {
									//scss 옵션 정의
									scss : {
										outputStyle: "expanded",  // 컴파일 스타일: nested(default), expanded, compact, compressed
										indentType: "space",      // 들여쓰기 스타일: space(default), tab
										indentWidth: 2,           // 들여쓰기 칸 수 (Default : 2)
										precision: 8,             // 컴파일 된 CSS 의 소수점 자리수 (Type : Integer , Default : 5)
										sourceComments: true,     // 코멘트 제거 여부 (Default : false)
										compiler: dartSass,       // 컴파일 도구
										fiber: Fiber,             // 컴파일 오버해드 방지
									},
									postcss: [ autoprefixer({
										overrideBrowserslist: apfBrwsowsers,
									}) ]
								};
								gulp.src(
										PATH.ASSETS.CSS + '/*.scss',                          // 컴파일 대상 scss파일 찾기
										{ since: gulp.lastRun('scss:compile') }               // 변경된 파일에 대해서만 scss:compile 진행
									)
									.pipe( plumber({errorHandler:onErrorHandler}) )
									// *.css 생성
									.pipe( dependents() )                                   // 종속된 scss파일(@import)까지 변경된 파일 감지하여 진행
									.pipe( sourcemaps.init() )                              // 소스맵 작성
									.pipe( scss(options.scss).on('error', scss.logError) )  // scss 옵션 적용, scss 작성시 watch가 멈추지 않도록 logError 설정
									.pipe( postCss(options.postcss) )                       // 하위 브라우저 고려
									.pipe( sourcemaps.write() )                             // 소스맵 적용
									.pipe( gulp.dest(DEST_PATH.ASSETS.CSS) )                // 컴파일 후 css파일이 생성될 목적지 설정
									.pipe( browserSync.reload({stream: true}) )             // 파일 변경 시 브라우저에 반영
									// *.min.css 생성
									.pipe( minificss() )                                    // 컴파일된 css 압축
									.pipe( rename({ suffix: '.min' }) )                     // 압축파일 *.min.css 생성
									.pipe( sourcemaps.write() )                             // 소스맵 적용
									.pipe( gulp.dest(DEST_PATH.ASSETS.CSS) )                // 컴파일 후 css파일이 생성될 목적지 설정
									.pipe( browserSync.reload({stream: true}) );            // 파일 변경 시 브라우저에 반영
								resolve();
							});
						});


						// html 빌드
						gulp.task('html', () => {
							return new Promise(resolve => {
								gulp
									.src([
										PATH.HTML + '/**/*',             // 불러올 파일의 위치
										'!' + PATH.HTML + '/**/_*',      // '_'로 시작하는 폴더 제외
										'!' + PATH.HTML + '/**/_*/**/*'  // '_'로 시작하는 폴더의 파일 및 하위 폴더 제외
									])
									.pipe( plumber({errorHandler:onErrorHandler}) )
									.pipe( fileinclude({
										prefix: '@@',
										basepath: '@file',
										indent : true,                   //include 되는 tab 사이즈에 맞춰 들여쓰기 적용(html 압축(htmlmin)을 사용한다면 효과 없음)
									}))
									.pipe( cached('html') )                                             // 빌드된 html cached에 저장 후 변경된 파일만 pipe 통과 (빌드 속도 개선)
									.pipe( htmlmin({collapseWhitespace: true, removeComments: true}) )  // html 압축 및 주석 제거
									.pipe( gulp.dest(DEST_PATH.HTML) )                                  // 컴파일 후 html파일이 생성될 목적지 설정
									.pipe( browserSync.reload({stream: true}) );                        // 파일 변경 시 브라우저에 반영
								resolve();
							});
						});


						// app.js 파일을 참조하여 express 서버 구동
						gulp.task('nodemon:start', () => {
							return new Promise(resolve => {
								nodemon({
									script: 'app.js',
									watch: DEST_PATH.HTML
								});
								resolve();
							});
						});


						// 변경, 추가, 삭제되는 파일을 감지하여 자동 빌드
						gulp.task('watch', () => {
							return new Promise(resolve => {
								const html_watcher = gulp.watch(PATH.HTML + "/**/*.html", gulp.series(['html']));   // html 폴더 내의 모든 파일 감시
								watcher_detail(html_watcher, PATH.HTML, DEST_PATH.HTML);                            // html 폴더 내의 삭제되는 파일 감시하여 dist에서 삭제

								const scss_watcher = gulp.watch(PATH.ASSETS.CSS + "/**/*.scss", gulp.series(['scss:compile']));  // css 폴더 내의 모든 파일 감시
								watcher_detail(scss_watcher, PATH.ASSETS.CSS, DEST_PATH.ASSETS.CSS);                             // css 폴더 내의 삭제되는 파일 감시하여 dist에서 삭제

								resolve();
							});
						});
						const watcher_detail = (watcher_target, src_path, dist_path) => {
							watcher_target.on('unlink', (filepath) => {
								const filePathFromSrc = path.relative(path.resolve(src_path), filepath);

								// scss 삭제 (min파일까지 생성했을 때)
								const extension_type = filePathFromSrc.split('.')[filePathFromSrc.split('.').length-1];
								if( extension_type === 'scss' ){
									const destFilePath_css = path.resolve(dist_path, filePathFromSrc).replace('scss','css');
									del.sync(destFilePath_css);
									const destFilePath_minCss = path.resolve(dist_path, filePathFromSrc).replace('scss','min.css');
									del.sync(destFilePath_minCss);
								}
								// html 삭제 (js. images, fonts 등은 task 생성하면서 테스트 예정)
								else{
									const destFilePath = path.resolve(dist_path, filePathFromSrc);
									del.sync(destFilePath);
								}
							});
						}


						// 빌드된 내용을 브라우저에 반영
						gulp.task('browserSync', () => {
							return new Promise(resolve => {
								browserSync.init(null, {
									proxy: 'http://localhost:8005',
									port: 8006
								});
								resolve();
							});
						});


						// 빌드 시 불필요한 파일 삭제
						gulp.task('clean', () => {
							return new Promise(resolve => {
								del.sync(dist+'/**', {force:true});
								resolve();
							});
						});


						// 실행 'clean',
						gulp.task( 'default', gulp.series(['clean', 'scss:compile', 'html', 'nodemon:start', 'browserSync', 'watch']));
					</textarea>
				</div>
			</li>

			<!-- gulp 실행 후 웹서버 확인 -->
			<li class="tit_h3 mt_xl" style="display:none;">
				<h3>gulp 실행 후 웹서버 확인</h3>
				<p class="mt_ms">
					<code>gulp</code>를 실행하여 정상적으로 빌드가 되는지 확인합니다.
				</p>
				<div class="terminal_code_box mt_ms">
					<textarea>
						gulp
					</textarea>
				</div>
				<p class="mt_ms">
					gulp 실행 후 <mark>dist 폴더</mark>를 보면 <mark>assets 형제 폴더</mark>로 <mark>page 폴더</mark>가 생성되어 있고,
					그 안에 <mark>sub.html</mark> 파일이 빌드된 것을 확인할 수 있습니다.<br>
					<mark>gulpfile.js</mark>에서 세팅한대로 <mark>_include 폴더</mark>와 <mark>하위 파일</mark>은 <mark>빌드에 제외되어 dist 폴더에는 존재하지 않습니다.</mark>
				</p>
				<p class="mt_ms"><img src="ukncs/images/gulp/gulp-file-include_2.png" alt="html 빌드 후 dist 폴더 구조"/></p>
				<p class="mt_ms">
					브라우저에는 수정한 style.scss에 맞게 include된 부분이 구분되어 보여집니다.
				</p>
				<p class="mt_ms"><img src="ukncs/images/gulp/b_index_sub.png" alt="빌드 후 웹서버"/></p>
				<p class="mt_ms">
					빌드된 html파일을 보면 아래처럼 include 템플릿이 병합되어 하나의 파일로 완성되어 있을 것을 확인할 수 있습니다.<br>
					<mark>gulpfile.js</mark>에 html 압축 기능까지 추가했기 때문에 아래 코드에서 빌드 수 압축 전화 후를 같이 확인 할 수 있습니다.(실제 빌드된 html은 압축되어 한줄로 보여집니다.)
				</p>
				<div class="uk_gist_code_box mt_ms" data-filename="index.html" data-tit="index.html">
					<textarea>
						<!-- 압축 전 ----------------------------- -->
						<!DOCTYPE html>
						<html lang="ko">
							<!-- head include -->
							<head>
								<meta charset="UTF-8">
								<title>Gulp setting</title>
								<meta name="viewport" content="width=device-width, initial-scale=1.0">
								<meta http-equiv="X-UA-Compatible" content="ie=edge">
								<link rel="stylesheet" href="./assets/css/style.css">
							</head>
							<body>
								<div class="wrap">
									<!-- header include -->
									<header class="header">
									<h1>Main page 입니다.</h1>
										<nav class="nav">
											<a href="/">main page</a>
											<a href="/page/sub.html">sub page</a>
										</nav>
									</header>
									&nbsp;
									<p>main content</p>
									&nbsp;
									<!-- footer include -->
									<footer class="footer">
										footer 영역 입니다.
									</footer>
								</div>
								<!-- //wrap -->
							</body>
						</html>

						<!-- 압축 후(실제 dist 빌드) ----------------------------- -->
						<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>Gulp setting</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="stylesheet" href="./assets/css/style.css"></head><body><div class="wrap"><header class="header"><h1>Main page 입니다.</h1><nav class="nav"><a href="/">main page</a> <a href="/page/sub.html">sub page</a></nav></header><p>main content</p><footer class="footer">footer 영역 입니다.</footer></div></body></html>
					</textarea>
				</div>
				<div class="uk_gist_code_box mt_ms" data-filename="sub.html" data-tit="sub.html">
					<textarea>
						<!-- 압축 전 ----------------------------- -->
						<!DOCTYPE html>
						<html lang="ko">
							<!-- head include -->
							<head>
								<meta charset="UTF-8">
								<title>Sub page | Gulp setting</title>
								<meta name="viewport" content="width=device-width, initial-scale=1.0">
								<meta http-equiv="X-UA-Compatible" content="ie=edge">
								<link rel="stylesheet" href="../assets/css/style.css">
							</head>
							<body>
								<div class="wrap">
									<!-- header include -->
									<header class="header">
									<h1>Sub page 입니다.</h1>
										<nav class="nav">
											<a href="/">main page</a>
											<a href="/page/sub.html">sub page</a>
										</nav>
									</header>
									&nbsp;
									<p>sub content</p>
									&nbsp;
									<!-- footer include -->
									<footer class="footer">
										footer 영역 입니다.
									</footer>
								</div>
								<!-- //wrap -->
							</body>
						</html>

						<!-- 압축 후(실제 dist 빌드) ----------------------------- -->
						<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>Sub page | Gulp setting</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="stylesheet" href="../assets/css/style.css"></head><body><div class="wrap"><header class="header"><h1>Sub page 입니다.</h1><nav class="nav"><a href="/">main page</a> <a href="/page/sub.html">sub page</a></nav></header><p>sub content</p><footer class="footer">footer 영역 입니다.</footer></div></body></html>
					</textarea>
				</div>
			</li>
		</ol>
	</section>
